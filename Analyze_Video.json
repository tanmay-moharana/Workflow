{
  "name": "YouTube Gaming Highlights to Shorts with Scoring & Logging",
  "nodes": [
    {
      "id": "1",
      "name": "Trigger Every 6h",
      "type": "n8n-nodes-base.cron",
      "parameters": {
        "triggerTimes": [{ "mode": "everyX", "unit": "hours", "value": 6 }]
      },
      "typeVersion": 1,
      "position": [200, 200]
    },
    {
      "id": "2",
      "name": "Get Channel Uploads",
      "type": "n8n-nodes-base.httpRequest",
      "parameters": {
        "url": "https://www.googleapis.com/youtube/v3/search",
        "authentication": "oAuth2",
        "queryParametersUi": {
          "parameter": [
            { "name": "part", "value": "snippet" },
            { "name": "channelId", "value": "UCqKZx0XQEFg6OD79XEfiERg" },
            { "name": "order", "value": "date" },
            { "name": "maxResults", "value": "5" },
            { "name": "type", "value": "video" }
          ]
        }
      },
      "typeVersion": 2,
      "position": [400, 200],
      "credentials": { "oAuth2Api": "YouTube OAuth2" }
    },
    {
      "id": "2a",
      "name": "Build Video URL",
      "type": "n8n-nodes-base.function",
      "parameters": {
        "functionCode": "if (!$json.id?.videoId) throw new Error('videoId not found');\nreturn [{ json: { videoUrl: `https://www.youtube.com/watch?v=${$json.id.videoId}` } }];"
      },
      "typeVersion": 1,
      "position": [600, 200]
    },
    {
      "id": "2b",
      "name": "Update & Download Video",
      "type": "n8n-nodes-base.executeCommand",
      "parameters": {
        "command": "bash",
        "arguments": [
          "-c",
          "yt-dlp -U && mkdir -p /data && yt-dlp --cookies /data/youtube-cookies.txt -f bestvideo+bestaudio/best --merge-output-format mp4 --compat-options no-youtube-legacy-dash -o /data/video.%(ext)s {{$json[\"videoUrl\"]}} --progress-template '%(progress)s%%'"
        ]
      },
      "typeVersion": 1,
      "position": [800, 200]
    },
    {
      "id": "2c",
      "name": "Parse Download Progress",
      "type": "n8n-nodes-base.function",
      "parameters": {
        "functionCode": "const log = $json.progress || '';\nconst match = log.match(/(\\d+\\.\\d+)%/);\nconst percentage = match ? match[1] : '0';\nreturn [{ json: { progress: percentage } }];"
      },
      "typeVersion": 1,
      "position": [1000, 150]
    },
    {
      "id": "2d",
      "name": "Telegram Download Progress",
      "type": "n8n-nodes-base.telegram",
      "parameters": {
        "operation": "sendMessage",
        "chatId": "<YOUR_CHAT_ID>",
        "text": "Download Progress: {{$json[\"progress\"]}}%"
      },
      "typeVersion": 1,
      "position": [1200, 150],
      "credentials": { "telegramApi": "Telegram Bot" }
    },
    {
      "id": "4",
      "name": "Analyze with Google Gemini Video",
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "parameters": {
        "resource": "video",
        "operation": "analyze",
        "input": "/data/video.mp4"
      },
      "typeVersion": 1,
      "position": [1000, 300]
    },
    {
      "id": "5",
      "name": "Rank Highlights (Excitement Score)",
      "type": "n8n-nodes-base.function",
      "parameters": {
        "functionCode": "const scenes = items[0].json.annotationResults[0].shotAnnotations;\nconst labels = items[0].json.annotationResults[0].segmentLabelAnnotations;\n\nfunction scoreScene(start, end) {\n  let score = 0;\n  const duration = end - start;\n\n  if (duration >= 15 && duration <= 45) score += 2;\n\n  for (const label of labels) {\n    for (const seg of label.segments) {\n      const segStart = seg.segment.startTimeOffset?.seconds || 0;\n      const segEnd = seg.segment.endTimeOffset?.seconds || 0;\n      if (segStart <= start && segEnd >= end) {\n        if ([\"Explosion\", \"Fight\", \"Cheering\", \"Gunshot\", \"Goal\"].includes(label.entity.description)) {\n          score += Math.round((label.confidence || 0) * 10);\n        }\n      }\n    }\n  }\n  return score;\n}\n\nconst ranked = scenes.map(s => {\n  const start = s.startTimeOffset?.seconds || 0;\n  const end = s.endTimeOffset?.seconds || 0;\n  return { start, end, score: scoreScene(start, end) };\n});\n\nranked.sort((a, b) => b.score - a.score);\n\nreturn ranked.slice(0, 3).map(s => ({ json: s }));"
      },
      "typeVersion": 1,
      "position": [1200, 300]
    },
    {
      "id": "6",
      "name": "Clip with FFmpeg",
      "type": "n8n-nodes-base.executeCommand",
      "parameters": {
        "command": "ffmpeg -ss {{$json[\"start\"]}} -i /data/video.mp4 -to {{$json[\"end\"]}} -vf \"scale=720:1280:force_original_aspect_ratio=decrease,pad=720:1280:(ow-iw)/2:(oh-ih)/2\" -c:a copy /tmp/shorts_{{$json[\"start\"]}}.mp4 -progress /tmp/ffmpeg_progress.log"
      },
      "typeVersion": 1,
      "position": [1400, 300]
    },
    {
      "id": "6a",
      "name": "Parse FFmpeg Progress",
      "type": "n8n-nodes-base.function",
      "parameters": {
        "functionCode": "const log = require('fs').readFileSync('/tmp/ffmpeg_progress.log','utf-8');\nconst timeMatch = log.match(/out_time_ms=(\\d+)/);\nconst durationMatch = log.match(/Duration: (\\d+):(\\d+):(\\d+)/);\nlet percentage = '0';\nif(timeMatch && durationMatch){\n  const out_ms = parseInt(timeMatch[1]);\n  const dur_sec = parseInt(durationMatch[1])*3600 + parseInt(durationMatch[2])*60 + parseInt(durationMatch[3]);\n  percentage = ((out_ms/1000000)/dur_sec*100).toFixed(1);\n}\nreturn [{ json: { progress: percentage } }];"
      },
      "typeVersion": 1,
      "position": [1600, 300]
    },
    {
      "id": "6b",
      "name": "Telegram FFmpeg Progress",
      "type": "n8n-nodes-base.telegram",
      "parameters": {
        "operation": "sendMessage",
        "chatId": "<YOUR_CHAT_ID>",
        "text": "Clipping Progress: {{$json[\"progress\"]}}%"
      },
      "typeVersion": 1,
      "position": [1800, 300],
      "credentials": { "telegramApi": "Telegram Bot" }
    },
    {
      "id": "7",
      "name": "Upload as YouTube Short",
      "type": "n8n-nodes-base.httpRequest",
      "parameters": {
        "url": "https://www.googleapis.com/upload/youtube/v3/videos?part=snippet,status",
        "method": "POST",
        "authentication": "oAuth2",
        "options": {},
        "jsonParameters": true,
        "body": {
          "snippet": {
            "title": "Gaming Highlight #shorts",
            "description": "Auto-generated highlight from gaming session",
            "tags": ["gaming", "shorts", "highlights"]
          },
          "status": { "privacyStatus": "public" }
        },
        "sendBinaryData": true,
        "binaryPropertyName": "data"
      },
      "typeVersion": 2,
      "position": [2000, 300],
      "credentials": { "oAuth2Api": "YouTube OAuth2" }
    },
    {
      "id": "8",
      "name": "Log to Google Sheets",
      "type": "n8n-nodes-base.googleSheets",
      "parameters": {
        "operation": "append",
        "sheetId": "1WImoOTdPiYiflny3WhgagxKS14RFT59WVtx1o0TPXAk",
        "range": "Highlights!A:D",
        "fields": {
          "values": [
            "={{$json[\"videoUrl\"]}}",
            "={{$json[\"start\"]}}â€“{{$json[\"end\"]}}",
            "={{$json[\"uploadResult\"][\"id\"]}}",
            "={{$json[\"score\"]}}"
          ]
        }
      },
      "typeVersion": 2,
      "position": [2200, 300],
      "credentials": { "googleApi": "Google Sheets OAuth2" }
    }
  ],
  "connections": {
    "1": { "main": [[{ "node": "Get Channel Uploads", "type": "main", "index": 0 }]] },
    "2": { "main": [[{ "node": "Build Video URL", "type": "main", "index": 0 }]] },
    "2a": { "main": [[{ "node": "Update & Download Video", "type": "main", "index": 0 }]] },
    "2b": { "main": [[{ "node": "Analyze with Google Gemini Video", "type": "main", "index": 0 }]] },
    "2c": { "main": [[{ "node": "Telegram Download Progress", "type": "main", "index": 0 }]] },
    "4": { "main": [[{ "node": "Rank Highlights (Excitement Score)", "type": "main", "index": 0 }]] },
    "5": { "main": [[{ "node": "Clip with FFmpeg", "type": "main", "index": 0 }]] },
    "6a": { "main": [[{ "node": "Telegram FFmpeg Progress", "type": "main", "index": 0 }]] },
    "6b": { "main": [[{ "node": "Parse FFmpeg Progress", "type": "main", "index": 0 }]] },
    "7": { "main": [[{ "node": "Upload as YouTube Short", "type": "main", "index": 0 }]] },
    "8": { "main": [[{ "node": "Log to Google Sheets", "type": "main", "index": 0 }]] }
  }
}
